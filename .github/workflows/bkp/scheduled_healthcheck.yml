name: Healthcheck Schedule

on:
  repository_dispatch:
    types: [healthcheck]
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [main, dev]

    steps:
      - name: Set URLs for ${{ matrix.environment }}
        run: |
          if [ "${{ matrix.environment }}" == "main" ]; then
            echo "URL_APP=${{ secrets.URL_APP_PRD }}" >> $GITHUB_ENV
            echo "URL_API=${{ secrets.URL_API_PRD }}" >> $GITHUB_ENV
          else
            echo "URL_APP=${{ secrets.URL_APP_DEV }}" >> $GITHUB_ENV
            echo "URL_API=${{ secrets.URL_API_DEV }}" >> $GITHUB_ENV
          fi

      - name: Health Check
        run: |
          echo "Monitorando: ${{ matrix.environment }}"

          status_app=$(curl --connect-timeout 10 --max-time 15 --write-out "%{http_code}" --silent --output /dev/null "$URL_APP")
          if [ "${status_app:-0}" -ge 200 ] && [ "${status_app:-0}" -lt 500 ]; then
            echo "‚úÖ App ${{ matrix.environment }} online: (Status $status_app)"
          else
            echo "‚ùå Erro: App ${{ matrix.environment }} down: (Status $status_app)"
            exit 1
          fi

          status_api=$(curl -X GET --connect-timeout 10 --max-time 15 --write-out "%{http_code}" --silent --output /dev/null "$URL_API")
          if [ "${status_api:-0}" -ge 200 ] && [ "${status_api:-0}" -lt 500 ]; then
            echo "‚úÖ API ${{ matrix.environment }} online: ($status_api)"
          else
            echo "‚ùå Erro: API ${{ matrix.environment }} down: ($status_api)"
            exit 1
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          MESSAGE="üö® <b>Falha no Healthcheck</b>"$'\n\n'
          MESSAGE+="üì¶ <b>Repo:</b> ${{ github.repository }}"$'\n'
          MESSAGE+="üåê <b>Ambiente:</b> ${{ matrix.environment }}"$'\n'
          MESSAGE+="üîó <b>Url App:</b> $URL_APP"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
               --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
               --data-urlencode "text=$MESSAGE" \
               -d "parse_mode=HTML"
