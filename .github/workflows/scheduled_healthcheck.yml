name: Healthcheck Schedule

on:
  schedule:
    - cron: '0 */9 * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [main, dev]

    steps:
      - name: Set URLs for ${{ matrix.environment }}
        run: |
          if [ "${{ matrix.environment }}" == "main" ]; then
            echo "URL_APP=https://prd-ideias-eventos-jovens-adupno.streamlit.app/" >> $GITHUB_ENV
            echo "URL_API=https://joaobarreto27-prd-youth-event-registration-app.hf.space/docs#/" >> $GITHUB_ENV
          else
            echo "URL_APP=https://dev-ideias-eventos-jovens-adupno.streamlit.app/" >> $GITHUB_ENV
            echo "URL_API=https://joaobarreto27-dev-youth-event-registration-app.hf.space/docs#/" >> $GITHUB_ENV
          fi

      - name: Health Check
        run: |
          echo "Monitorando: ${{ matrix.environment }}"

          status_app=$(curl --connect-timeout 10 --max-time 15 --write-out "%{http_code}" --silent --output /dev/null "$URL_APP")
          if [ "${status_app:-0}" -ge 200 ] && [ "${status_app:-0}" -lt 500 ]; then
            echo "‚úÖ App ${{ matrix.environment }} online: (Status $status_app)"
          else
            echo "‚ùå Erro: App ${{ matrix.environment }} down: (Status $status_app)"
            exit 1
          fi

          # Ping API
          status_api=$(curl -X GET --connect-timeout 10 --max-time 15 --write-out "%{http_code}" --silent --output /dev/null "$URL_API")
          if [ "${status_api:-0}" -ge 200 ] && [ "${status_api:-0}" -lt 500 ]; then
            echo "‚úÖ API ${{ matrix.environment }} online: ($status_api)"
          else
            echo "‚ùå Erro: API ${{ matrix.environment }} down: ($status_api)"
            exit 1
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          MESSAGE="üö® *Falha no Healthcheck* %0A%0A"
          MESSAGE+="üì¶ *Repo:* ${{ github.repository }} %0A"
          MESSAGE+="üåê *Ambiente:* ${{ matrix.environment }} %0A"
          MESSAGE+="üîó [Ver Logs aqui](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # Enviando via API do Telegram
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
               -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
               -d "text=$MESSAGE" \
               -d "parse_mode=Markdown"
